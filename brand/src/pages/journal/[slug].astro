---
import Layout from '../../layouts/Layout.astro';
import { client } from '../../lib/sanity';
import { PortableText } from 'astro-portabletext';

export async function getStaticPaths() {
  const posts = await client.fetch(`*[_type == "post"]{ "slug": slug.current }`);
  return posts.map((post: any) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const post = await client.fetch(`*[_type == "post" && slug.current == $slug][0]{
  title,
  publishedAt,
  body,
  "imageUrl": mainImage.asset->url
}`, { slug });

if (!post) {
  return Astro.redirect('/404');
}
---

<Layout title={post.title}>
	<article class="post-content fade-in-up">
		<header class="post-header">
			<time datetime={post.publishedAt}>
				{new Date(post.publishedAt).toLocaleDateString('ja-JP')}
			</time>
			<h1 class="zen-mincho">{post.title}</h1>
		</header>

		{post.imageUrl && (
			<div class="featured-image">
				<img src={post.imageUrl} alt={post.title} />
			</div>
		)}

		<div class="prose">
			<PortableText value={post.body} />
		</div>

		<footer class="post-footer">
			<a href="/journal" class="back-link">← 戻る</a>
		</footer>
	</article>
</Layout>

<style>
	.post-content {
		max-width: 700px;
		margin: 0 auto;
		padding: 6rem 2rem;
	}

	.post-header {
		text-align: center;
		margin-bottom: 4rem;
	}

	time {
		font-family: monospace;
		color: var(--accent-primary);
		display: block;
		margin-bottom: 1rem;
	}

	h1 {
		font-size: 2.5rem;
		line-height: 1.4;
	}

	.featured-image {
		margin-bottom: 4rem;
		border: 1px solid rgba(255, 255, 255, 0.05);
	}

	.featured-image img {
		width: 100%;
		height: auto;
		display: block;
	}

	.prose {
		line-height: 2;
		color: var(--text-muted);
		font-size: 1.05rem;
		letter-spacing: 0.02em;
	}

	.prose :global(p) {
		margin-bottom: 2rem;
	}

	.prose :global(h2) {
		color: var(--text-primary);
		font-size: 1.8rem;
		margin: 4rem 0 1.5rem;
		font-family: 'Zen Old Mincho', serif;
	}

	.prose :global(img) {
		max-width: 100%;
		height: auto;
		margin: 2rem 0;
	}

	.post-footer {
		margin-top: 6rem;
		padding-top: 2rem;
		border-top: 1px solid rgba(255, 255, 255, 0.05);
	}

	.back-link {
		text-decoration: none;
		color: var(--accent-primary);
		font-size: 0.9rem;
		transition: opacity 0.3s;
	}

	.back-link:hover {
		opacity: 0.7;
	}
</style>
