---
import Layout from '../layouts/Layout.astro';
import { client } from '../lib/sanity';
import imageUrlBuilder from '@sanity/image-url';

const builder = imageUrlBuilder(client);
function urlFor(source: any) {
  return builder.image(source);
}

// Fetch items from Sanity
const items = await client.fetch(`*[_type == "shushuanItem"]{
  _id,
  name,
  category,
  era,
  story,
  status,
  price,
  tags,
  "imageUrl": mainImage.asset->url
}`);

const tags = [
  { id: 'all', label: 'All' },
  { id: 'Antique', label: 'Antique' },
  { id: 'Music', label: 'Music' },
  { id: 'Word', label: 'Word' },
];
---

<Layout>
	<div class="catalog-wrapper">
		<!-- Left Pane: Preview / Story -->
		<aside class="preview-pane">
			<div id="preview-content" class="preview-content">
				<div id="preview-image-container" class="preview-image-container"></div>
				<div class="preview-meta">
					<span id="preview-era"></span>
					<span id="preview-category"></span>
				</div>
				<h1 id="preview-title">蒐集物目録</h1>
				<div id="preview-story">
					<p>物質としての機能だけでなく、<br />その背後にある物語と時間を蒐集しました。</p>
				</div>
			</div>
		</aside>

		<!-- Right Pane: Grid -->
		<main class="grid-pane">
			<div class="tag-filter-container">
				{tags.map(tag => (
					<button class="tag-filter" data-tag={tag.id}>{tag.label}</button>
				))}
			</div>

			<section id="item-grid" class="item-grid">
				{items.map((item: any, index: number) => (
					<article 
						class="item-card fade-in-up" 
						style={`animation-delay: ${index * 0.1}s`}
						data-item={JSON.stringify(item)}
					>
						<div class="card-image-wrapper">
							{item.imageUrl ? (
								<img src={item.imageUrl} alt={item.name} class="card-img" />
							) : (
								<div class="card-placeholder"></div>
							)}
						</div>
						<div class="card-info">
							<h3 class="card-title">{item.name}</h3>
							<div class="card-footer">
								<span class="card-price">
									{item.price ? `¥${item.price.toLocaleString()}` : '—'}
								</span>
								{item.price && (
									<button 
										class="purchase-btn" 
										data-item={JSON.stringify({
											itemId: item._id,
											name: item.name,
											price: item.price,
											imageUrl: item.imageUrl
										})}
									>
										所望する
									</button>
								)}
							</div>
						</div>
					</article>
				))}
			</section>
		</main>
	</div>
</Layout>

<script>
	const items = document.querySelectorAll('.item-card');
	const previewContent = document.getElementById('preview-content');
	const previewTitle = document.getElementById('preview-title');
	const previewStory = document.getElementById('preview-story');
	const previewEra = document.getElementById('preview-era');
	const previewCategory = document.getElementById('preview-category');
	const previewImg = document.getElementById('preview-image-container');

	items.forEach(card => {
		card.addEventListener('mouseenter', () => {
			const data = JSON.parse(card.getAttribute('data-item') || '{}');
			
			// Simple transition effect
			if (previewContent) {
				previewContent.style.opacity = '0';
				previewContent.style.transform = 'translateY(10px)';
				
				setTimeout(() => {
					if (previewTitle) previewTitle.textContent = data.name;
					if (previewStory) previewStory.innerHTML = data.story ? data.story.replace(/\n/g, '<br>') : '';
					if (previewEra) previewEra.textContent = data.era;
					if (previewCategory) previewCategory.textContent = data.category;
					
					if (previewImg) {
						if (data.imageUrl) {
							previewImg.style.display = 'block';
							previewImg.innerHTML = `<img src="${data.imageUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 2px;">`;
						} else {
							previewImg.style.display = 'none';
						}
					}
					
					previewContent.style.opacity = '1';
					previewContent.style.transform = 'translateY(0)';
				}, 200);
			}
		});
	});

	// Tag Filtering (Client-side)
	const tags = document.querySelectorAll('.tag-filter');
	tags.forEach(tag => {
		tag.addEventListener('click', () => {
			const targetTag = tag.getAttribute('data-tag');
			tags.forEach(t => t.classList.remove('active'));
			tag.classList.add('active');

			items.forEach(card => {
				const data = JSON.parse(card.getAttribute('data-item') || '{}');
				if (targetTag === 'all' || data.category === targetTag) {
					(card as HTMLElement).style.display = 'block';
				} else {
					(card as HTMLElement).style.display = 'none';
				}
			});
		});
	});

	// Stripe Checkout
	const purchaseBtns = document.querySelectorAll('.purchase-btn');
	purchaseBtns.forEach(btn => {
		btn.addEventListener('click', async (e) => {
			e.stopPropagation(); // Don't trigger hover/modal
			const itemData = JSON.parse(btn.getAttribute('data-item') || '{}');
			
			btn.textContent = '準備中...';
			(btn as HTMLButtonElement).disabled = true;

			try {
				const response = await fetch('/api/checkout', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(itemData),
				});

				const { url, error } = await response.json();
				if (url) {
					window.location.href = url;
				} else {
					alert(`Error: ${error}`);
					btn.textContent = '所望する';
					(btn as HTMLButtonElement).disabled = false;
				}
			} catch (err) {
				console.error(err);
				alert('通信エラーが発生しました。');
				btn.textContent = '所望する';
				(btn as HTMLButtonElement).disabled = false;
			}
		});
	});
</script>

<style>
	.catalog-wrapper {
		display: flex;
		min-height: 100vh;
	}

	.preview-pane {
		width: 40%;
		height: 100vh;
		position: sticky;
		top: 0;
		padding: 6rem 4rem;
		border-right: 1px solid rgba(0, 0, 0, 0.05);
	}

	.preview-content {
		transition: all 0.3s ease;
	}

	.preview-image-container {
		margin-bottom: 2rem;
		width: 100%;
		aspect-ratio: 4/3;
		background: rgba(0, 0, 0, 0.03);
		overflow: hidden;
		border-radius: 2px;
		display: none;
	}

	.preview-meta {
		display: flex;
		gap: 1.5rem;
		margin-bottom: 2rem;
		font-size: 0.8rem;
		color: var(--text-muted);
		text-transform: uppercase;
		letter-spacing: 0.1em;
	}

	#preview-title {
		font-size: 2.5rem;
		margin-bottom: 2.5rem;
		font-weight: 500;
		color: var(--accent-primary);
	}

	#preview-story {
		line-height: 2.2;
		color: var(--text-primary);
	}

	.grid-pane {
		width: 60%;
		padding: 8rem 4rem;
	}

	.tag-filter-container {
		margin-bottom: 4rem;
		display: flex;
		gap: 1rem;
		flex-wrap: wrap;
	}

	.tag-filter {
		background: transparent;
		border: 1px solid transparent;
		font-family: inherit;
		color: var(--text-muted);
		cursor: pointer;
		padding: 0.5rem 1rem;
		transition: all 0.3s;
		font-size: 0.8rem;
	}

	.tag-filter.active {
		color: var(--accent-primary);
		border-bottom: 1px solid var(--accent-primary);
		font-weight: bold;
	}

	.item-grid {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 4rem;
	}

	.item-card {
		cursor: pointer;
	}

	.card-image-wrapper {
		aspect-ratio: 1;
		background: rgba(0, 0, 0, 0.03);
		margin-bottom: 1.5rem;
		overflow: hidden;
		transition: transform 0.3s;
	}

	.item-card:hover .card-image-wrapper {
		transform: translateY(-5px);
	}

	.card-img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform 0.5s;
	}

	.item-card:hover .card-img {
		transform: scale(1.05);
	}

	.card-title {
		font-size: 1rem;
		margin: 0 0 0.8rem;
		font-weight: 500;
	}

	.card-footer {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.card-price {
		font-size: 0.9rem;
		color: var(--text-muted);
		font-family: monospace;
	}

	.purchase-btn {
		background: transparent;
		border: 1px solid var(--accent-primary);
		color: var(--accent-primary);
		padding: 0.4rem 0.8rem;
		font-size: 0.75rem;
		cursor: pointer;
		transition: all 0.3s;
		font-family: inherit;
		letter-spacing: 0.1em;
	}

	.purchase-btn:hover {
		background: var(--accent-primary);
		color: var(--bg-primary);
	}

	.purchase-btn:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	@media (max-width: 900px) {
		.catalog-wrapper {
			flex-direction: column;
		}
		.preview-pane {
			width: 100%;
			height: auto;
			position: static;
			padding: 4rem 2rem;
		}
		.grid-pane {
			width: 100%;
			padding: 2rem;
		}
		.item-grid {
			grid-template-columns: 1fr;
		}
	}
</style>
